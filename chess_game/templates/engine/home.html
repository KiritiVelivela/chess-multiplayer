{% extends 'base.html' %}

{% block title %}Chess Game{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="text-center mb-4">CSCI 620: Chess Game by Satya Kiriti Velivela</h2>
    <div class="row">
        <!-- Challenge Player Section -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title text-center">Challenge a Player</h4>
                    <form method="POST">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="player_black" class="form-label">Choose a Player to Challenge:</label>
                            <select name="player_black" class="form-control" id="player_black" required>
                                {% for player in available_players %}
                                    <option value="{{ player.id }}">{{ player.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="d-grid gap-2 mt-3">
                            <button type="submit" class="btn btn-primary">Challenge Player</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Challenge Requests Section -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title text-center">Challenge Requests</h4>
                    <div id="challenge-requests">
                        <p>Loading challenges...</p>
                    </div>
                </div>
            </div>
            <br/>
            <!-- Game History Section -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h4 class="card-title text-center">Game History</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Opponent</th>
                                        <th>Result</th>
                                        <th>No. of Moves</th>
                                        <th>Journal</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for game in games %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            {% if game.player_white == user %}
                                                {{ game.player_black.username }}
                                            {% else %}
                                                {{ game.player_white.username }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if game.winner == user %}
                                                <span class="badge bg-success">Win</span>
                                            {% elif game.winner %}
                                                <span class="badge bg-danger">Loss</span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark">Ongoing</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ game.move_count }}</td>
                                        <td>{{ game.journal_entry|default:"None" }}</td>
                                        <td>
                                            <a href="{% url 'edit_journal' game.id %}" class="btn btn-primary btn-sm">Edit</a>
                                            <form method="POST" action="{% url 'delete_game' game.id %}" style="display:inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this game?');">Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const homeSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/home/'
    );

    homeSocket.onopen = function () {
        console.log("WebSocket connected.");
        // Request challenges and available players on connect
        homeSocket.send(JSON.stringify({ action: "get_challenges" }));
        homeSocket.send(JSON.stringify({ action: "get_available_players" }));
    };

    homeSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        if (data.type === "challenges") {
            const challengeRequestsDiv = document.querySelector("#challenge-requests");
            if (data.challenges.length > 0) {
                let challengesHTML = "<ul>";
                data.challenges.forEach(challenge => {
                    challengesHTML += `
                        <li>
                            ${challenge.challenger} has challenged you to a game!
                            <button onclick="respondChallenge(${challenge.id}, 'accept')" class="btn btn-success">Accept</button>
                            <button onclick="respondChallenge(${challenge.id}, 'reject')" class="btn btn-danger">Reject</button>
                        </li>
                    `;
                });
                challengesHTML += "</ul>";
                challengeRequestsDiv.innerHTML = challengesHTML;
            } else {
                challengeRequestsDiv.innerHTML = "<p>No new challenges.</p>";
            }
        }

        if (data.type === "game_history") {
            const gameHistoryTable = document.querySelector("tbody");
            gameHistoryTable.innerHTML = "";  // Clear existing rows

            data.games.forEach((game, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${game.opponent}</td>
                        <td>
                            ${game.result === "Win" ? '<span class="badge bg-success">Win</span>' : 
                            game.result === "Loss" ? '<span class="badge bg-danger">Loss</span>' : 
                            '<span class="badge bg-warning text-dark">Ongoing</span>'}
                        </td>
                        <td>${game.move_count}</td>
                        <td>${game.journal_entry}</td>
                        <td>
                            <a href="/edit_journal/${game.id}/" class="btn btn-primary btn-sm">Edit</a>
                            <form method="POST" action="/delete_game/${game.id}/" style="display:inline;">
                                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this game?');">Delete</button>
                            </form>
                        </td>
                    </tr>
                `;
                gameHistoryTable.innerHTML += row;
            });
        }

        if (data.type === "available_players") {
            const playerSelect = document.getElementById("player_black");
            playerSelect.innerHTML = "";  // Clear existing options

            data.players.forEach(player => {
                const option = document.createElement("option");
                option.value = player.id;
                option.textContent = player.username;
                playerSelect.appendChild(option);
            });
        }

        if (data.type === "game_start") {
            if (data.game_url) {
                console.log("inside IF");
                console.log(data)
                console.log("===========================")
                window.location.href = data.game_url;  // Redirect to game URL
            } else {
                console.error("Game start URL is missing.");
                console.error(data);
            }
        }
    };

    homeSocket.onclose = function () {
        console.error("WebSocket closed. Reconnecting in 5 seconds...");
        setTimeout(() => {
            location.reload(); // Refresh to reconnect
        }, 5000);
    };

    function respondChallenge(challengeId, action) {
        homeSocket.send(JSON.stringify({
            action: "respond_challenge",
            challenge_id: challengeId,
            response: action
        }));
    }
</script>
{% endblock %}