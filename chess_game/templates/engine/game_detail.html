{% extends 'base.html' %}

{% block title %}Chess Game{% endblock %}

{% block content %}
{% if user.is_authenticated %}
<h2 class="text-center">CSCI 620: Chess Game by Satya Kiriti Velivela</h2>

<div class="row justify-content-center">
    <div class="chessboard-container">
        {% include 'engine/partials/chessboard.html' %}
    </div>
</div>

<div class="row justify-content-center text-center">
    <div class="chessboardButtons">
        <form id="move-form" method="POST">
            {% csrf_token %}
            <input type="text" id="move-input" placeholder="Enter move (e.g., e2e4)" name="move" class="form-control d-inline-block" style="width: auto; display: inline;">
            <button type="submit" class="btn btn-primary">Move</button>
        </form>
    </div>
</div>

<div class="row justify-content-center">
    <div class="row justify-content-center">
        <button type="button" class="btn btn-danger" id="resignButton">Resign</button>
    </div>
</div>


<!-- Display who is playing as White or Black -->
<div class="row justify-content-center">
    <div class="alert alert-info">
        {% if user == game.player_white %}
            You are playing as <strong>White</strong>.
        {% elif user == game.player_black %}
            You are playing as <strong>Black</strong>.
        {% endif %}
    </div>
</div>

<!-- Show whose turn it is -->
<div class="row justify-content-center">
    <div class="alert turn-indicator {% if board.turn == chess.WHITE %}alert-light{% else %}alert-dark{% endif %}">
        It's {% if board.turn == chess.WHITE %}White{% else %}Black{% endif %}'s turn.
    </div>
</div>

{% if invalid_move %}
    <div class="alert alert-danger">
        Invalid move: {{ invalid_move }}
    </div>
{% endif %}

<hr/>
{% endif %}
<script>
    const gameSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/game/{{ game.id }}/'
    );

    gameSocket.onopen = function(e) {
        console.log("WebSocket connected.");
    }

    document.getElementById("resignButton").addEventListener("click", function () {
        if (confirm("Are you sure you want to resign?")) {
            console.log("INSIDE RESIGN CONFIRMATION")
            // Send a resignation event via WebSocket
            gameSocket.send(JSON.stringify({
                'action': 'game_resigned'
            }));
        }
    });

    gameSocket.onmessage = function(e) {
        
        const data = JSON.parse(e.data);

        if (data.status === 'success') {
            updateBoard(data.fen, data.turn);  // Update board and turn
        } else if (data.status === 'error') {
            alert(data.message);  // Show error messages
        } else if (data.type === "game_resigned") {
            console.log(`Game resigned by opponent. Winner: ${data.winner}`);
            // alert(`The game is over. ${data.winner} has won!`);
            showResignationModal(data.winner);
        }
    };

    gameSocket.onclose = function(e) {
        console.error('WebSocket closed unexpectedly');
    };

    document.querySelector('#move-form').onsubmit = function(e) {
        e.preventDefault();
        const moveInput = document.querySelector('#move-input').value;

        gameSocket.send(JSON.stringify({
            'action': 'move',
            'move': moveInput
        }));

        document.querySelector('#move-input').value = '';
    };

    function updateBoard(fen, turn) {
        // Update the board via an AJAX request or render client-side
        $.ajax({
            url: "{% url 'update_board' game.id %}",
            method: "GET",
            success: function(data) {
                $('#chessboard-with-border').html(data.board_html);

                // Update whose turn it is
                if (turn) {
                    $('.turn-indicator').text("It's White's turn!").removeClass('alert-dark').addClass('alert-light');
                } else {
                    $('.turn-indicator').text("It's Black's turn!").removeClass('alert-light').addClass('alert-dark');
                }
            }
        });
    }

    function showResignationModal(winner) {
        const modalHTML = `
            <div class="modal fade" id="resignationModal" tabindex="-1" aria-labelledby="resignationModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="resignationModalLabel">Game Over</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            The game is over. <strong>${winner}</strong> has won!
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id="homeRedirectButton">Go to Home</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('resignationModal'));
        modal.show();

        // Redirect to home after a delay or button click
        document.getElementById('homeRedirectButton').onclick = function () {
            window.location.href = '/';
        };

        setTimeout(() => {
            window.location.href = '/';
        }, 5000);
    }
</script>
{% endblock %}