{% extends 'base.html' %}

{% block title %}Chess Game{% endblock %}

{% block content %}
{% if user.is_authenticated %}
<h2 class="text-center">CSCI 620: Chess Game by Satya Kiriti Velivela</h2>

<div class="row justify-content-center">
    <div class="chessboard-container">
        {% include 'engine/partials/chessboard.html' %}
    </div>
</div>

<div class="row justify-content-center text-center">
    <div class="chessboardButtons">
        <form id="move-form" method="POST">
            {% csrf_token %}
            <input type="text" id="move-input" placeholder="Enter move (e.g., e2e4)" name="move" class="form-control d-inline-block" style="width: auto; display: inline;">
            <button type="submit" class="btn btn-primary">Move</button>
        </form>
    </div>
</div>

<div class="row justify-content-center">
    <form method="POST" action="{% url 'resign_game' game.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">Resign</button>
    </form>
</div>


<!-- Display who is playing as White or Black -->
<div class="row justify-content-center">
    <div class="alert alert-info">
        {% if user == game.player_white %}
            You are playing as <strong>White</strong>.
        {% elif user == game.player_black %}
            You are playing as <strong>Black</strong>.
        {% endif %}
    </div>
</div>

<!-- Show whose turn it is -->
<div class="row justify-content-center">
    <div class="alert turn-indicator {% if board.turn == chess.WHITE %}alert-light{% else %}alert-dark{% endif %}">
        It's {% if board.turn == chess.WHITE %}White{% else %}Black{% endif %}'s turn.
    </div>
</div>

{% if invalid_move %}
    <div class="alert alert-danger">
        Invalid move: {{ invalid_move }}
    </div>
{% endif %}

<hr/>
{% endif %}
<script>

let lastBoardFen = "{{ game.current_fen }}";  // Store the last known board state

function checkGameStatus() {
    $.ajax({
        url: "{% url 'check_game_status' game.id %}",
        method: "GET",
        success: function(data) {
            if (data.game_over) {
                // If the game is over, display a message and redirect to the result page
                alert("The game is over. Winner: " + data.winner);
                window.location.href = "{% url 'game_over' game.id %}";
            } else {
                // If the board state has changed, update it dynamically
                if (data.board_fen !== lastBoardFen) {
                    updateBoard(data.board_fen, data.turn);  // Function to update the board based on FEN
                    lastBoardFen = data.board_fen;  // Update the last known board state
                }
            }
        }
    });
}

$('#move-form').submit(function(event) {
    event.preventDefault();  // Prevent the default form submission

    // Get the move input
    var move = $('#move-input').val();

    // Disable polling during move submission
    clearInterval(gameStatusInterval);

    $.ajax({
        url: "{% url 'game_detail' game.id %}",
        method: "POST",
        data: {
            'move': move,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.invalid_move) {
                // Show invalid move message
                alert(response.invalid_move);
            } else {
                // Update the board with the new move
                updateBoard(response.board_fen, response.turn);
                $('#move-input').val('');  // Clear the move input field
                lastBoardFen = response.board_fen;  // Update the last known board state
            }

            // Re-enable polling after move submission
            gameStatusInterval = setInterval(checkGameStatus, 5000);
        },
        error: function() {
            alert("An error occurred while submitting the move.");

            // Re-enable polling if there was an error
            gameStatusInterval = setInterval(checkGameStatus, 5000);
        }
    });
});

// Function to update the board using the FEN string dynamically
function updateBoard(fen, turn) {
    $.ajax({
        url: "{% url 'update_board' game.id %}",
        method: "GET",
        success: function(data) {
            $('#chessboard-with-border').html(data.board_html);

            if (turn) {
                // It's White's turn
                $('.turn-indicator').text("It's White's turn!").removeClass('alert-dark').addClass('alert-light');
            } else {
                // It's Black's turn
                $('.turn-indicator').text("It's Black's turn!").removeClass('alert-light').addClass('alert-dark');
            }
        },
        error: function() {
            alert("An error occurred while updating the board.");
        }
    });
}

// Start polling only if the game is ongoing
let gameStatusInterval;
{% if is_ongoing %}
    gameStatusInterval = setInterval(checkGameStatus, 5000);  // Poll every 5 seconds
{% endif %}


</script>
{% endblock %}